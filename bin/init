#!/bin/bash -ex

bosh_app_dir=${NISE_PATH}
bosh_dir=${bosh_app_dir}/bosh

#apt-get update
yum clean all && yum makecache

# stemcell_builder/stages/base_apt/apply.sh
#DEBIAN_FRONTEND=noninteractive apt-get install -o Dpkg::Options::="--force-confnew" -f -y \
#--force-yes --no-install-recommends \
#build-essential libssl-dev lsof \
#strace bind9-host dnsutils tcpdump iputils-arping \
#curl wget libcurl3 libcurl3-dev bison libreadline6-dev \
#libxml2 libxml2-dev libxslt1.1 libxslt1-dev zip unzip \
#nfs-common flex psmisc apparmor-utils iptables sysstat \
#rsync openssh-server traceroute libncurses5-dev quota \
#libaio1 gdb tripwire libcap2-bin libyaml-dev

yum groupinstall -y "Development Tools"
yum install -y openssl-devel lsof strace bind bind-libs bind-utils\
tcpdump iproute curl wget libcurl-devel bison readline-devel libxml2 libxml2-devel\
libxslt libxslt-devel zip unzip nfs-utils flex psmisc iptables sysstat rsync openssh-server\
traceroute ncurses-libs quota libaio gdb tripwire libyaml-devel

# stemcell_builder/stages/bosh_monit/apply.sh
DEBIAN_FRONTEND=noninteractive apt-get install -o Dpkg::Options::="--force-confnew" -f -y \
--force-yes --no-install-recommends runit

mkdir -p /package
chmod 1755 /package

cd /package
wget http://smarden.org/runit/runit-2.1.1.tar.gz
tar -xzp -f runit-2.1.1.tar.gz
rm -f runit-2.1.1.tar.gz
cd admin/runit-2.1.1

package/install

# installed somewhere else
#DEBIAN_FRONTEND=noninteractive apt-get install -o Dpkg::Options::="--force-confnew" -f -y \
#--force-yes --no-install-recommends gettext

yum install -y gettext
# bosh_agent/lib/bosh_agent/platform/ubuntu/templates/logrotate.erb
cat <<EOF > /etc/logrotate.d/nise_bosh
$bosh_app_dir/sys/log/*.log $bosh_app_dir/sys/log/*/*.log $bosh_app_dir/sys/log/*/*/*.log {
  missingok
  rotate 7
  compress
  delaycompress
  copytruncate
  size=100M
}
EOF

# stemcell_builder/stages/bosh_users/apply.sh
if [ `cat /etc/passwd | cut -f1 -d ":" | grep "^work$" -c` -eq 0 ]; then
    addgroup --system work
    adduser --disabled-password --gecos Ubuntu work

    for grp in work adm audio cdrom dialout floppy video plugdev dip
    do
        adduser work $grp
    done
else
    echo "User work exists already, skippking adduser..."
fi

# stemcell_builder/stages/system_kernel/apply.sh
#if [ -d /boot/grub ]; then
#    if [ `lsb_release -cs` ==  "lucid" ]; then
#        variant="lts-backport-oneiric"
#
#        # Headers are needed for open-vm-tools
#        apt-get install -y linux-image-virtual-${variant} linux-headers-virtual-${variant}
#    else
#        apt-get install -y linux-image-virtual linux-image-extra-virtual
#    fi
#fi
# stemcell_builder/stages/bosh_monit/apply.sh
monit_basename=monit-5.2.4
(
    cd /tmp
    wget "http://mmonit.com/monit/dist/${monit_basename}.tar.gz" -O ${monit_basename}.tar.gz
    tar xvzf ${monit_basename}.tar.gz
    cd ${monit_basename}
    ./configure --prefix=$bosh_dir --without-ssl
    make -j4 && make install
)
mkdir -p $bosh_dir/etc
cat <<EOF > /$bosh_dir/etc/monitrc
set daemon 10
set logfile $bosh_app_dir/monit/monit.log

set httpd port 2822 and use address 127.0.0.1
  allow cleartext $bosh_app_dir/monit/monit.user

include $bosh_app_dir/monit/*.monitrc
include $bosh_app_dir/monit/job/*.monitrc
EOF
chmod 0700 $bosh_dir/etc/monitrc
mkdir -p $bosh_app_dir/monit
touch $bosh_app_dir/monit/empty.monitrc

echo Done.

if [ ! -d /sys/fs/cgroup ]; then
    echo "Restart may be required"
fi
